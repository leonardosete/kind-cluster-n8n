################################################################################
# 04 â€“ Deploy da stack n8n via ArgoCD                                          #
#                                                                              #
# â–¸ Pode rodar manualmente (workflow_dispatch)                                 #
# â–¸ TambÃ©m Ã© chamado pelo workflow 02 via workflow_call                        #
################################################################################
name: 04-Deploy-n8n-stack-via-ArgoCD

on:
  workflow_dispatch:
  workflow_call:

jobs:
  aplicar-apps:
    runs-on: [self-hosted]

    steps:
    - uses: actions/checkout@v4

    # 1 â–¸ Executa playbook localmente no runner (VPS)
    - name: ğŸš€ Aplica Applications no ArgoCD (direto no host)
      working-directory: ./ansible-hostinger
      run: |
        echo "::group::Executando playbook deploy n8n localmente"
        ansible-playbook -i inventory.ini ansible-deploy-n8n.yml
        echo "::endgroup::"

    # 2 â–¸ Mensagem final com URLs de acesso
    - name: âœ… Resultado final
      run: |
        echo "========================== âœ… DEPLOY CONCLUÃDO =========================="
        echo "ğŸŒ Acesse o ArgoCD: https://argocd-test.devops-master.shop"
        echo "ğŸ”‘ Login: admin"
        echo "ğŸ”‘ Senha: $(kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath='{.data.password}' | base64 --decode)"
        echo "ğŸŒ Acesse o n8n: https://n8n.devops-master.shop"
        echo "ğŸŒ Acesse o Evolution API: https://evolution-api.devops-master.shop/manager"
        echo "==========================================================================="
  