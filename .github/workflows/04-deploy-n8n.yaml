################################################################################
# 04 – Deploy da stack n8n via ArgoCD                                          #
#                                                                              #
# ▸ Pode rodar manualmente (workflow_dispatch)                                 #
# ▸ Também é chamado pelo workflow 02 via workflow_call                        #
################################################################################
name: 04-Deploy-n8n-stack-via-ArgoCD

on:
  workflow_dispatch:
  workflow_call:

jobs:
  aplicar-apps:
    runs-on: [self-hosted]

    steps:
    - uses: actions/checkout@v4

    # 1 ▸ Executa playbook localmente no runner (VPS)
    - name: 🚀 Aplica Applications no ArgoCD (direto no host)
      working-directory: ./ansible-hostinger
      run: |
        echo "::group::Executando playbook deploy n8n localmente"
        ansible-playbook -i inventory.ini ansible-deploy-n8n.yml
        echo "::endgroup::"

    # 2 ▸ Mensagem final com URLs de acesso
    - name: ✅ Resultado final
      run: |
        echo "========================== ✅ DEPLOY CONCLUÍDO =========================="
        echo "🌐 Acesse o ArgoCD: https://argocd-test.devops-master.shop"
        echo "🔑 Login: admin"
        echo "🔑 Senha: $(kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath='{.data.password}' | base64 --decode)"
        echo "🌐 Acesse o n8n: https://n8n.devops-master.shop"
        echo "🌐 Acesse o Evolution API: https://evolution-api.devops-master.shop/manager"
        echo "==========================================================================="
  