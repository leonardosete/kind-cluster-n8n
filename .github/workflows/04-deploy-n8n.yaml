name: 04-Deploy-n8n-stack-via-ArgoCD

on:
  workflow_dispatch:
  workflow_call:

jobs:
  aplicar-apps:
    runs-on: [self-hosted]  # executado diretamente na VPS

    steps:
    - name: ğŸ“¦ Checkout do repositÃ³rio
      uses: actions/checkout@v4

    - name: ğŸ“ Cria diretÃ³rio e move manifests para /root/argo-apps (local na VPS)
      run: |
        echo "::group::ğŸ“ Preparando manifests para ArgoCD"
        mkdir -p /root/argo-apps
        cp ./argo-apps/*.yaml /root/argo-apps/
        echo "::endgroup::"

    - name: ğŸš€ Executa Ansible para aplicar Applications no ArgoCD
      working-directory: ./ansible-hostinger
      run: |
        echo "::group::ğŸš€ Executando playbook"
        ansible-playbook -i inventory.ini ansible-deploy-n8n.yml
        echo "::endgroup::"

    - name: âœ… Resultado final
      run: |
        echo "========================== âœ… DEPLOY CONCLUÃDO =========================="
        echo "ğŸŒ Acesse o ArgoCD: https://argocd-test.devops-master.shop"
        echo "ğŸ‘¤ Login: admin"
        echo "ğŸ”‘ Senha: $(kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath='{.data.password}' | base64 --decode)"
        echo "ğŸŒ Acesse o n8n: https://n8n.devops-master.shop"
        echo "ğŸŒ Acesse o Evolution API: https://evolution-api.devops-master.shop/manager"
        echo "==========================================================================="
