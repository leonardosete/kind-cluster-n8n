name: 04-Deploy-n8n-stack-via-ArgoCD

on:
  workflow_dispatch:
  workflow_call:

jobs:
  aplicar-apps:
    runs-on: [self-hosted]  # executado diretamente na VPS

    steps:
    - name: 📦 Checkout do repositório
      uses: actions/checkout@v4

    - name: 📁 Cria diretório e move manifests para /root/argo-apps (local na VPS)
      run: |
        echo "::group::📁 Preparando manifests para ArgoCD"
        mkdir -p /root/argo-apps
        cp ./argo-apps/*.yaml /root/argo-apps/
        echo "::endgroup::"

    - name: 🚀 Executa Ansible para aplicar Applications no ArgoCD
      working-directory: ./ansible-hostinger
      run: |
        echo "::group::🚀 Executando playbook"
        ansible-playbook -i inventory.ini ansible-deploy-n8n.yml
        echo "::endgroup::"

    - name: ✅ Resultado final
      run: |
        echo "========================== ✅ DEPLOY CONCLUÍDO =========================="
        echo "🌐 Acesse o ArgoCD: https://argocd-test.devops-master.shop"
        echo "👤 Login: admin"
        echo "🔑 Senha: $(kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath='{.data.password}' | base64 --decode)"
        echo "🌐 Acesse o n8n: https://n8n.devops-master.shop"
        echo "🌐 Acesse o Evolution API: https://evolution-api.devops-master.shop/manager"
        echo "==========================================================================="
