################################################################################
# 01 ‚Äì Configs VPS + Instalar Cluster KIND                                     #
#                                                                              #
# ‚ñ∏ Disparo manual via workflow_dispatch                                       #
# ‚ñ∏ Chama o workflow 02-infra-base via workflow_call                           #
################################################################################
name: 01-Configs VPS + Instalar Cluster KIND

on:
  workflow_dispatch:
    inputs:
      acionar_infra_base:
        description: "‚ö†Ô∏è  Executar tamb√©m o deploy da INFRA BASE? (cert-manager, ArgoCD‚Ä¶) "
        required: true
        default: false
        type: boolean

jobs:
  configure-vps-kind-cluster:
    runs-on: self-hosted

    steps:
    - name: üì¶ Checkout reposit√≥rio
      uses: actions/checkout@v4

    # 1 ‚ñ∏ Instala pacotes necess√°rios no runner
    - name: üîß Instala depend√™ncias (Ansible, SSH, kubectl)
      run: |
        echo "::group::Instalando depend√™ncias"
        sudo apt-get update -y
        sudo apt-get install -y ansible sshpass openssh-client curl
        ansible-galaxy collection install community.kubernetes
        curl -sLO "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl && sudo mv kubectl /usr/local/bin/
        echo "::endgroup::"

    # 2 ‚ñ∏ Prepara SSH
    - name: üîê Configura chave SSH
      run: |
        echo "::group::Configurando SSH"
        install -d -m 0700 ~/.ssh
        printf '%s' '${{ secrets.SSH_PRIVATE_KEY }}' > ~/.ssh/${{ secrets.SSH_KEY_FILENAME }}
        chmod 600 ~/.ssh/${{ secrets.SSH_KEY_FILENAME }}
        ssh-keyscan -H ${{ secrets.VPS_HOSTNAME }} >> ~/.ssh/known_hosts
        echo "::endgroup::"

    - name: üîç Valida chave no runner
      run: ssh-keygen -y -f ~/.ssh/${{ secrets.SSH_KEY_FILENAME }} >/dev/null

    # 3 ‚ñ∏ Executa playbook KIND
    - name: ‚öôÔ∏è Playbook Ansible ‚Äì KIND
      working-directory: ./ansible-hostinger
      run: |
        echo "::group::Executando playbook KIND"
        ansible-playbook -i inventory.ini 01-ansible-vps-kind.yaml
        echo "::endgroup::"

  # 4 ‚ñ∏ Aciona workflow 02 (infra base) se habilitado
  deploy-infra-base:
    if: ${{ github.event.inputs.acionar_infra_base == 'true' }}
    needs: configure-vps-kind-cluster
    uses: ./.github/workflows/02-infra-base.yaml
    with:
      criar_infra_base: true
    secrets: inherit
