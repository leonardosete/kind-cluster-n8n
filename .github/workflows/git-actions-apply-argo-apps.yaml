name: Aplicar Applications no ArgoCD

on:
  push:
#    branches:
#      - main
  workflow_dispatch:

jobs:
  aplicar-apps:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Checkout do repositÃ³rio
      uses: actions/checkout@v3

    - name: ğŸ” Prepara chave SSH da VPS
      run: |
        echo "::group::ğŸ” Preparando chave SSH"
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/${{ vars.SSH_KEY_FILENAME }}
        chmod 600 ~/.ssh/${{ vars.SSH_KEY_FILENAME }}
        ssh-keyscan -H ${{ vars.VPS_HOSTNAME }} >> ~/.ssh/known_hosts
        echo "::endgroup::"

    - name: ğŸ“ Cria diretÃ³rio /root/argo-apps e envia manifests para VPS
      run: |
        echo "::group::ğŸ“ Copiando arquivos argo-apps para a VPS"
        ssh -i ~/.ssh/${{ vars.SSH_KEY_FILENAME }} ${{ vars.VPS_USER }}@${{ vars.VPS_HOSTNAME }} "mkdir -p /root/argo-apps"
        scp -i ~/.ssh/${{ vars.SSH_KEY_FILENAME }} argo-apps/*.yaml ${{ vars.VPS_USER }}@${{ vars.VPS_HOSTNAME }}:/root/argo-apps/
        echo "::endgroup::"

    - name: ğŸ“ Cria diretÃ³rio /root/secrets e envia secret template para VPS
      run: |
        echo "::group::ğŸ“ Copiando template de Secret para a VPS"
        ssh -i ~/.ssh/${{ vars.SSH_KEY_FILENAME }} ${{ vars.VPS_USER }}@${{ vars.VPS_HOSTNAME }} "mkdir -p /root/secrets"
        scp -i ~/.ssh/${{ vars.SSH_KEY_FILENAME }} secrets/gt-dash-secret.yaml.j2 ${{ vars.VPS_USER }}@${{ vars.VPS_HOSTNAME }}:/root/secrets/
        echo "::endgroup::"

    - name: ğŸš€ Executa Ansible para aplicar Applications no ArgoCD
      working-directory: ./ansible-hostinger
      env:
        GH_DASH_TOKEN: ${{ secrets.GH_DASH_TOKEN }}
      run: |
        echo "::group::ğŸš€ Executando playbook"
        ansible-playbook -i inventory.ini ansible-apply-argo-apps.yml
        echo "::endgroup::"

    - name: âœ… Resultado final
      run: |
        echo ""
        echo "====================== âœ… FINALIZADO ======================"
        echo "âœ”ï¸ Applications foram aplicados se ainda nÃ£o existiam."
        echo "ğŸŒ Acesse o painel do ArgoCD: https://argocd-test.devops-master.shop"
        echo "=========================================================="
