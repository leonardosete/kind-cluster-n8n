name: 03-Generate-SealedSecrets

################################################################################
# Gatilhos                                                                     #
################################################################################
# â€¢ Pode ser disparado manualmente (workflow_dispatch)                          #
# â€¢ Ou chamado de outro workflow (workflow_call)                                #
################################################################################
on:
  workflow_dispatch:
    inputs:
      app_name:
        description: AplicaÃ§Ã£o-alvo (n8n, n8n-postgres, evolution-api, â€¦)
        required: true
        type: string

  workflow_call:
    inputs:
      app_name:
        required: true
        type: string

################################################################################
# Job Ãºnico: gera o SealedSecret e aplica no cluster                           #
################################################################################
jobs:
  seal-and-apply:
    runs-on: ubuntu-latest

    # Todos os *GitHub Secrets* ficam visÃ­veis para os passos via $VAR
    # (adicione novos nomes se criar mais chaves no futuro)
    env:
      # evolution-api
      EVOLUTION_API_AUTHENTICATION_API_KEY: ${{ secrets.EVOLUTION_API_AUTHENTICATION_API_KEY }}
      EVOLUTION_API_CACHE_REDIS_URI:        ${{ secrets.EVOLUTION_API_CACHE_REDIS_URI }}
      EVOLUTION_API_DATABASE_CONNECTION_URI: ${{ secrets.EVOLUTION_API_DATABASE_CONNECTION_URI }}
      EVOLUTION_API_POSTGRES_DB:            ${{ secrets.EVOLUTION_API_POSTGRES_DB }}
      EVOLUTION_API_POSTGRES_PASSWORD:      ${{ secrets.EVOLUTION_API_POSTGRES_PASSWORD }}
      EVOLUTION_API_POSTGRES_USER:          ${{ secrets.EVOLUTION_API_POSTGRES_USER }}

      # evolution-postgres
      EVOLUTION_POSTGRES_POSTGRES_DB:       ${{ secrets.EVOLUTION_POSTGRES_POSTGRES_DB }}
      EVOLUTION_POSTGRES_POSTGRES_PASSWORD: ${{ secrets.EVOLUTION_POSTGRES_POSTGRES_PASSWORD }}
      EVOLUTION_POSTGRES_POSTGRES_USER:     ${{ secrets.EVOLUTION_POSTGRES_POSTGRES_USER }}

      # n8n-postgres
      N8N_POSTGRES_POSTGRES_DB:             ${{ secrets.N8N_POSTGRES_POSTGRES_DB }}
      N8N_POSTGRES_POSTGRES_PASSWORD:       ${{ secrets.N8N_POSTGRES_POSTGRES_PASSWORD }}
      N8N_POSTGRES_POSTGRES_USER:           ${{ secrets.N8N_POSTGRES_POSTGRES_USER }}

      # n8n (app)
      N8N_DB_POSTGRESDB_DATABASE:           ${{ secrets.N8N_DB_POSTGRESDB_DATABASE }}
      N8N_DB_POSTGRESDB_PASSWORD:           ${{ secrets.N8N_DB_POSTGRESDB_PASSWORD }}
      N8N_DB_POSTGRESDB_USER:               ${{ secrets.N8N_DB_POSTGRESDB_USER }}
      N8N_ENCRYPTION_KEY:                   ${{ secrets.N8N_ENCRYPTION_KEY }}

    steps:
    - uses: actions/checkout@v4

    # 1 â–¸ kubeconfig exportado no workflow 01
    - name: â¬‡ï¸  Baixa kubeconfig da VPS
      uses: actions/download-artifact@v4
      with:
        name: kubeconfig-vps
        path: .

    - name: ğŸ”§ Define $KUBECONFIG
      run: echo "KUBECONFIG=${{ github.workspace }}/kubeconfig-vps" >> "$GITHUB_ENV"

    # 2 â–¸ instala kubectl + kubeseal
    - name: ğŸ› ï¸  Instala kubectl e kubeseal
      run: |
        curl -sLO "https://dl.k8s.io/release/$(curl -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl && sudo mv kubectl /usr/local/bin/
        curl -L "https://github.com/bitnami-labs/sealed-secrets/releases/latest/download/kubeseal-$(uname -s)-amd64" \
          -o kubeseal && chmod +x kubeseal && sudo mv kubeseal /usr/local/bin/

    # 3 â–¸ constrÃ³i a variÃ¡vel SECRET_KEYS (lista de chaves) conforme a app
    - name: ğŸ”‘  Define SECRET_KEYS
      run: |
        case "${{ inputs.app_name }}" in
          evolution-api)
            echo "SECRET_KEYS=EVOLUTION_API_AUTHENTICATION_API_KEY,EVOLUTION_API_CACHE_REDIS_URI,EVOLUTION_API_DATABASE_CONNECTION_URI,EVOLUTION_API_POSTGRES_DB,EVOLUTION_API_POSTGRES_PASSWORD,EVOLUTION_API_POSTGRES_USER" >> $GITHUB_ENV
            ;;
          evolution-postgres)
            echo "SECRET_KEYS=EVOLUTION_POSTGRES_POSTGRES_DB,EVOLUTION_POSTGRES_POSTGRES_PASSWORD,EVOLUTION_POSTGRES_POSTGRES_USER" >> $GITHUB_ENV
            ;;
          n8n-postgres)
            echo "SECRET_KEYS=N8N_POSTGRES_POSTGRES_DB,N8N_POSTGRES_POSTGRES_PASSWORD,N8N_POSTGRES_POSTGRES_USER" >> $GITHUB_ENV
            ;;
          n8n)
            echo "SECRET_KEYS=N8N_DB_POSTGRESDB_DATABASE,N8N_DB_POSTGRESDB_PASSWORD,N8N_DB_POSTGRESDB_USER,N8N_ENCRYPTION_KEY" >> $GITHUB_ENV
            ;;
          *)
            echo "âŒ AplicaÃ§Ã£o nÃ£o suportada: ${{ inputs.app_name }}"; exit 1 ;;
        esac

    # 4 â–¸ gera & aplica SealedSecret
    - name: ğŸ”  Gera e aplica SealedSecret
      run: |
        chmod +x scripts/generate-sealedsecret-apps.sh
        scripts/generate-sealedsecret-apps.sh "${{ inputs.app_name }}" n8n-vps
        kubectl apply -f "apps/${{ inputs.app_name }}/templates/sealedsecret-${{ inputs.app_name }}.yaml"
