name: Gerar & Aplicar SealedSecrets

on:
  workflow_dispatch:
  workflow_call:                 # permite ser invocado por outros
    inputs:
      app_name:
        type: string
        required: true
    secrets:
      DB_USER:    {required: true}
      DB_PASS:    {required: true}
    # (...adicione quantos precisar)

jobs:
  seal-and-apply:
    needs: deploy-infra           # vem do git-act-2-infra-base
    runs-on: ubuntu-latest
    env:
      VPS_HOSTNAME:  ${{ vars.VPS_HOSTNAME }}
      KUBECONFIG:    ${{ github.workspace }}/kubeconfig-vps
      SECRET_KEYS:   "DB_USER,DB_PASS"

    steps:
    - uses: actions/checkout@v4

    - name: ⬇️ Baixa kubeconfig artifact
      uses: actions/download-artifact@v4
      with:
        name: kubeconfig-vps
        path: .

    - name: 🔧 Instala kubectl + kubeseal
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
        curl -LO "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl && sudo mv kubectl /usr/local/bin/
        curl -L https://github.com/bitnami-labs/sealed-secrets/releases/latest/download/kubeseal-$(uname -s)-amd64 > kubeseal
        chmod +x kubeseal && sudo mv kubeseal /usr/local/bin/

    - name: 🔐 Gera e aplica SealedSecret
      env:
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASS: ${{ secrets.DB_PASS }}
      run: |
        bash scripts/2-create-sealedsecret-apps.sh "${{ inputs.app_name }}" n8n-vps
        kubectl apply -f apps/${{ inputs.app_name }}/templates/sealedsecret-${{ inputs.app_name }}.yaml
