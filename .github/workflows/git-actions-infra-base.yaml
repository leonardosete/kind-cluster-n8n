name: Deploy de Infraestrutura Base no Cluster KIND

on:
  workflow_dispatch:
    inputs:
      descricao:
        description: "âš ï¸ Este workflow instala cert-manager e ArgoCD. Confirma a execuÃ§Ã£o?"
        required: true
        default: "false"

jobs:
  deploy-infra:
    if: ${{ github.event.inputs.descricao == 'sim' }}
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Checkout do repositÃ³rio
      uses: actions/checkout@v3

    - name: ğŸ”§ Instala dependÃªncias (Ansible + kubectl)
      run: |
        echo "::group::ğŸ› ï¸ Instalando dependÃªncias"
        sudo apt-get update
        sudo apt-get install -y ansible sshpass openssh-client curl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl && sudo mv kubectl /usr/local/bin/
        echo "::endgroup::"

    - name: ğŸ” Configura chave SSH da VPS
      run: |
        echo "::group::ğŸ” Adicionando chave SSH"
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/${{ vars.SSH_KEY_FILENAME }}
        chmod 600 ~/.ssh/${{ vars.SSH_KEY_FILENAME }}
        ssh-keyscan -H ${{ vars.VPS_HOSTNAME }} >> ~/.ssh/known_hosts
        echo "âœ… Chave SSH configurada"
        echo "::endgroup::"

    - name: âš™ï¸ Executa o playbook de infraestrutura base
      working-directory: ./ansible-hostinger
      run: |
        echo "::group::ğŸš€ Deploy da infraestrutura base no cluster KIND"
        ansible-playbook -i inventory.ini ansible-infra-base.yml
        echo "::endgroup::"

    - name: âœ… âš ï¸ IMPORTANTE âš ï¸ âœ…
      run: |
        echo ""
        echo "====================== âœ… INFRA BASE PRONTA ======================"
        echo ""
        echo "Cert-manager e ArgoCD instalados com sucesso!"
        echo ""
        echo "ğŸŒ URL: https://argocd-test.devops-master.shop"
        echo "ğŸ‘¤ UsuÃ¡rio: admin"
        echo "ğŸ” Para descobrir a senha do usuÃ¡rio admin, execute no servidor:"
        echo ""
        echo "kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=\"{.data.password}\" | base64 -d && echo"
        echo ""
        echo "âœ… VocÃª pode acessar o ArgoCD agora e fazer o login"
        echo ""
        echo "==============================================================="


